<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Call - Production</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        video {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC Video Call - Production</h1>
        
        <div class="input-group">
            <input type="text" id="username" placeholder="Username" value="User1">
            <input type="text" id="room" placeholder="Room" value="main-room">
            <button class="btn btn-success" onclick="connect()">Connect</button>
        </div>
        
        <div class="video-container">
            <div>
                <h3>Local Video</h3>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div>
                <h3>Remote Video</h3>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-success" id="startCallBtn" onclick="console.log('Button clicked!'); startCall()" disabled>Start Call</button>
            <button class="btn btn-danger" id="endCallBtn" onclick="endCall()" disabled>End Call</button>
            <button class="btn btn-warning" id="answerCallBtn" onclick="answerCall()" style="display:none;">Answer Call</button>
        </div>
        
        <div class="status" id="status">Disconnected</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        let app = {
            username: '',
            room: '',
            localStream: null,
            peerConnection: null,
            stompClient: null,
            isInCall: false,
            backendUrl: 'https://your-aws-domain.elasticbeanstalk.com' // UPDATE THIS
        };

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function connect() {
            app.username = document.getElementById('username').value;
            app.room = document.getElementById('room').value;
            
            updateStatus('Connecting...');
            
            navigator.mediaDevices.getUserMedia({video: true, audio: true})
                .then(stream => {
                    app.localStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    
                    const socket = new SockJS(app.backendUrl + '/ws');
                    app.stompClient = Stomp.over(socket);
                    
                    app.stompClient.connect({}, () => {
                        updateStatus('Connected');
                        document.getElementById('startCallBtn').disabled = false;
                        
                        fetch(app.backendUrl + '/api/v1/signaling/rooms/' + app.room + '/join', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username: app.username})
                        });
                        
                        app.stompClient.subscribe('/topic/signaling/' + app.room, (msg) => {
                            const data = JSON.parse(msg.body);
                            handleSignaling(data);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error accessing media devices:', error);
                    updateStatus('Error: No camera/mic');
                });
        }

        async function sendSignalingMessage(message) {
            try {
                console.log('Sending via HTTP fallback:', message);
                const response = await fetch(app.backendUrl + '/api/v1/signaling/signaling', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(message)
                });
                console.log('HTTP signaling response:', response);
            } catch (error) {
                console.error('Error sending signaling message:', error);
            }
        }

        function startCall() {
            console.log('=== START CALL ===');
            console.log('app.localStream:', app.localStream);
            
            if (!app.localStream) {
                console.error('No local stream available!');
                updateStatus('Error: No camera/mic');
                return;
            }
            
            if (app.isInCall) {
                console.log('Already in a call, cannot start another');
                updateStatus('Already in a call');
                return;
            }
            
            updateStatus('Starting call...');
            
            app.peerConnection = new RTCPeerConnection({
                iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
            });
            
            app.localStream.getTracks().forEach(track => {
                app.peerConnection.addTrack(track, app.localStream);
            });
            
            app.peerConnection.ontrack = (e) => {
                document.getElementById('remoteVideo').srcObject = e.streams[0];
                updateStatus('In call');
            };
            
            app.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate:', event.candidate);
                    sendSignalingMessage({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        from: app.username,
                        room: app.room
                    });
                }
            };
            
            app.peerConnection.createOffer()
                .then(offer => app.peerConnection.setLocalDescription(offer))
                .then(() => {
                    sendSignalingMessage({
                        type: 'offer',
                        offer: app.peerConnection.localDescription,
                        from: app.username,
                        room: app.room
                    });
                    app.isInCall = true;
                    updateStatus('Calling...');
                    document.getElementById('endCallBtn').disabled = false;
                });
        }

        function answerCall() {
            console.log('=== ANSWER CALL START ===');
            console.log('app.pendingOffer:', app.pendingOffer);
            
            app.isInCall = true;
            document.getElementById('endCallBtn').disabled = false;
            
            app.peerConnection = new RTCPeerConnection({
                iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
            });
            
            app.localStream.getTracks().forEach(track => {
                app.peerConnection.addTrack(track, app.localStream);
            });
            
            app.peerConnection.ontrack = (e) => {
                document.getElementById('remoteVideo').srcObject = e.streams[0];
                updateStatus('In call');
            };
            
            app.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate:', event.candidate);
                    sendSignalingMessage({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        from: app.username,
                        room: app.room
                    });
                }
            };
            
            console.log('Setting remote offer...');
            app.peerConnection.setRemoteDescription(app.pendingOffer)
                .then(() => {
                    console.log('Remote offer set, creating answer...');
                    return app.peerConnection.createAnswer();
                })
                .then(answer => {
                    console.log('Answer created, setting local description...');
                    return app.peerConnection.setLocalDescription(answer);
                })
                .then(() => {
                    console.log('Sending answer...');
                    sendSignalingMessage({
                        type: 'answer',
                        answer: app.peerConnection.localDescription,
                        from: app.username,
                        room: app.room
                    });
                    console.log('=== ANSWER CALL END ===');
                })
                .catch(error => {
                    console.error('Answer call error:', error);
                });
        }

        function endCall() {
            console.log('=== END CALL ===');
            
            sendSignalingMessage({
                type: 'call-ended',
                from: app.username,
                room: app.room
            });
            
            app.isInCall = false;
            app.isInitiator = false;
            app.pendingOffer = null;
            
            if (app.peerConnection) {
                app.peerConnection.close();
                app.peerConnection = null;
            }
            
            document.getElementById('remoteVideo').srcObject = null;
            
            const answerBtn = document.getElementById('answerCallBtn');
            if (answerBtn) {
                answerBtn.style.display = 'none';
            }
            
            updateStatus('Connected');
            document.getElementById('endCallBtn').disabled = true;
            
            console.log('=== END CALL COMPLETE ===');
        }

        function handleSignaling(data) {
            console.log('=== HANDLE SIGNALING ===');
            console.log('Received data:', data);
            console.log('data.type:', data.type);
            console.log('app.isInCall:', app.isInCall);
            
            if (data.type === 'offer' && !app.isInCall) {
                console.log('Processing offer...');
                app.isInCall = false;
                app.pendingOffer = data.offer;
                const answerBtn = document.getElementById('answerCallBtn');
                console.log('Answer button found:', answerBtn);
                answerBtn.style.display = 'inline-block';
                console.log('Answer button should now be visible');
            } else if (data.type === 'answer' && app.isInCall) {
                console.log('Processing answer...');
                app.peerConnection.setRemoteDescription(data.answer);
            } else if (data.type === 'ice-candidate' && app.peerConnection) {
                console.log('Processing ICE candidate:', data.candidate);
                app.peerConnection.addIceCandidate(data.candidate)
                    .then(() => console.log('ICE candidate added successfully'))
                    .catch(error => console.error('Error adding ICE candidate:', error));
            } else if (data.type === 'call-ended') {
                console.log('Call ended by:', data.from);
                if (app.isInCall) {
                    endCall();
                }
            }
            
            console.log('=== HANDLE SIGNALING END ===');
        }
    </script>
</body>
</html>
